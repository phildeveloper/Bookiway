@page "/"
@page "/translation"
@layout EmptyLayout
@rendermode InteractiveServer

@using System.IO
@using System.Linq
@using BookiwayApp.Services

@inject PdfDecomposerService PdfDecomposer
@inject IJSRuntime JS
@inject GeminiTranslationService Translator

<PageTitle>Translation</PageTitle>

<div class="translation-page">
    <h1 class="translation-title">–ü–µ—Ä–µ–≤–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
    <p class="translation-subtitle">–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ —à–∞–≥–∏ –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —à—É–º–∞.</p>

    <div class="upload-card">
        <h2 class="upload-heading">1. –í—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</h2>

        <label class="file-picker" for="pdfUpload">
            <span class="file-picker-icon" aria-hidden="true">üìÑ</span>
            <span class="file-picker-text">@(_fileName is null ? "–í—ã–±—Ä–∞—Ç—å PDF —Ñ–∞–π–ª" : _fileName)</span>
            <InputFile id="pdfUpload" OnChange="HandleFileSelected" accept="application/pdf" />
        </label>
        <p class="upload-hint">–§–æ—Ä–º–∞—Ç: PDF (–¥–æ 10 –ú–ë). –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ cookies.</p>
        @if (!string.IsNullOrWhiteSpace(_lastPdfName) && _selectedFile is null)
        {
            <p class="selected-file" aria-live="polite">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª: @_lastPdfName (–Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Å–Ω–æ–≤–∞)</p>
        }

        <div class="directory-input">
            <h2 class="upload-heading" style="margin-top:1.25rem;">2. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü</h2>
            <div class="directory-input-row">
                <span class="directory-textbox" style="flex:1">@(_outputDirectory is null || _outputDirectory.Trim().Length==0 ? "–ü–∞–ø–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞" : _outputDirectory)</span>
                <button type="button" class="browse-directory-button" @onclick="() => OpenDirectoryPicker(DirectoryTarget.Images)" disabled="@_isProcessing">–í—ã–±—Ä–∞—Ç—å‚Ä¶</button>
            </div>
            <p class="directory-hint">–ü—É—Ç—å –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫. –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—É—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ cookies.</p>
        </div>

        <h2 class="upload-heading" style="margin-top:1.5rem;">3. –î–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å PDF –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</h2>
        <button class="decompose-button" @onclick="StartDecompositionAsync" disabled="@IsDecomposeDisabled">
            @if (_isProcessing)
            {
                <span class="spinner" aria-hidden="true"></span>
            }
            <span>–î–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å</span>
        </button>

        @if (_isProcessing)
        {
            <div class="decompose-progress" role="status" aria-live="polite">
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" style="width: @_progressPercent%;"></div>
                </div>
                <span class="progress-text">@_progressPercent%</span>
            </div>
        }

        @if (!string.IsNullOrEmpty(_statusMessage))
        {
            var statusClass = _isSuccess ? "status-message success" : "status-message error";
            <div class="@statusClass">@_statusMessage</div>
        }

        <div class="directory-input" style="margin-top:1.5rem">
            <h2 class="upload-heading">4. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</h2>
            <div class="directory-input-row">
                <input type="number" min="1" max="@_totalPages" value="@_pageFrom" @oninput="OnPageFromChanged" class="directory-textbox" style="max-width:140px" />
                <span>‚Äî</span>
                <input type="number" min="1" max="@_totalPages" value="@_pageTo" @oninput="OnPageToChanged" class="directory-textbox" style="max-width:140px" />
                <span style="margin-left:.5rem">–∏–∑ @_totalPages</span>
            </div>
            @if (!string.IsNullOrEmpty(_pageRangeError))
            {
                <div class="directory-error" role="alert" style="margin-top:.5rem">@_pageRangeError</div>
            }
            @if (_totalPages == 0)
            {
                <div class="status-message" style="margin-top:.75rem">–°—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£–∫–∞–∂–∏—Ç–µ –ø–∞–ø–∫—É —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ (—à–∞–≥ 2) –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é (—à–∞–≥ 3).</div>
            }
        </div>

        <div class="directory-input" style="margin-top:1.25rem">
            <h2 class="upload-heading">5. –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è HTML –ø–µ—Ä–µ–≤–æ–¥–∞</h2>
            <div class="directory-input-row">
                <span class="directory-textbox" style="flex:1">@(_translationOutputDirectory is null || _translationOutputDirectory.Trim().Length==0 ? "–ü–∞–ø–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞" : _translationOutputDirectory)</span>
                <button type="button" class="browse-directory-button" @onclick="() => OpenDirectoryPicker(DirectoryTarget.Html)" disabled="@(_isTranslating)">–í—ã–±—Ä–∞—Ç—å‚Ä¶</button>
            </div>
            <p class="directory-hint">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—É—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ cookies.</p>
        </div>

        <div style="margin-top:1.25rem">
            <h2 class="upload-heading">6. –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</h2>
            <button class="browse-directory-button" @onclick="StartTranslationAsync" disabled="@(!_isPageRangeValid || _totalPages == 0 || string.IsNullOrWhiteSpace(_translationOutputDirectory) || _isTranslating)">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é Gemini</button>

            @if (_isTranslating)
            {
                <div class="decompose-progress" role="status" aria-live="polite" style="margin-top:.75rem">
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill" style="width: @_translateProgress%;"></div>
                    </div>
                    <span class="progress-text">@_translateProgress%</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(_translateStatus))
            {
                var tClass = _translateSuccess ? "status-message success" : "status-message error";
                <div class="@tClass" style="margin-top:.75rem">@_translateStatus</div>
            }
        </div>
    </div>

    @if (_isDirectoryPickerOpen)
    {
        <div class="directory-modal" role="dialog" aria-modal="true">
            <div class="directory-modal-content">
                <div class="directory-modal-header">
                    <h3>Select destination folder</h3>
                    <p class="directory-modal-path" title="@_directoryBrowserPath">@_directoryBrowserPath</p>
                </div>

                @if (!string.IsNullOrEmpty(_directoryBrowserError))
                {
                    <div class="directory-error" role="alert">@_directoryBrowserError</div>
                }

                <div class="directory-browser">
                    <div class="directory-browser-actions">
                        <button type="button" class="directory-nav-button" @onclick="NavigateUp" disabled="@(!CanNavigateUp)">‚¨Ü Parent folder</button>
                        <button type="button" class="directory-nav-button" @onclick="RefreshCurrentDirectory">‚Üª Refresh</button>
                    </div>

                    <ul class="directory-list" role="listbox">
                        @if (_directoryEntries.Count == 0)
                        {
                            <li class="directory-empty">No subdirectories</li>
                        }
                        else
                        {
                            @foreach (var entry in _directoryEntries)
                            {
                                <li>
                                    <button type="button" class="directory-item" @onclick="() => NavigateToDirectory(entry.FullPath)">
                                        <span aria-hidden="true">üìÅ</span>
                                        <span>@entry.Name</span>
                                    </button>
                                </li>
                            }
                        }
                    </ul>
                </div>

                <div class="directory-modal-footer">
                    <button type="button" class="confirm-button" @onclick="ConfirmDirectorySelection">Use this folder</button>
                    <button type="button" class="cancel-button" @onclick="CloseDirectoryPicker">Cancel</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private const long MaxFileSize = 10 * 1024 * 1024;

    private IBrowserFile? _selectedFile;
    private string? _fileName;
    private string _outputDirectory = string.Empty;
    private string _translationOutputDirectory = string.Empty;
    private string? _lastPdfName;
    private int _totalPages;
    private int _pageFrom = 1;
    private int _pageTo = 1;
    private bool _isPageRangeValid = true;
    private string? _pageRangeError;
    private bool _isProcessing;
    private bool _isTranslating;
    private int _translateProgress;
    private string? _translateStatus;
    private bool _translateSuccess;
    private int _progressPercent;
    private string? _statusMessage;
    private bool _isSuccess;
    private bool _isDirectoryPickerOpen;
    private string _directoryBrowserPath = string.Empty;
    private List<DirectoryEntry> _directoryEntries = new();
    private string? _directoryBrowserError;

    private bool IsDecomposeDisabled => _selectedFile is null || string.IsNullOrWhiteSpace(TrimmedOutputDirectory) || _isProcessing;
    private bool CanNavigateUp => TryGetParentDirectory(_directoryBrowserPath) is not null;
    private string TrimmedOutputDirectory => _outputDirectory?.Trim() ?? string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Restore from cookies
            _lastPdfName = await JS.InvokeAsync<string?>("cookies.get", "bw_last_pdf_name");
            var lastDir = await JS.InvokeAsync<string?>("cookies.get", "bw_last_output_dir");
            if (!string.IsNullOrWhiteSpace(lastDir))
            {
                _outputDirectory = lastDir!;
                RecalculatePagesFromImagesFolder();
            }
            var lastHtml = await JS.InvokeAsync<string?>("cookies.get", "bw_last_html_dir");
            if (!string.IsNullOrWhiteSpace(lastHtml))
            {
                _translationOutputDirectory = lastHtml!;
            }
            StateHasChanged();
        }
    }

    private async void HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _fileName = e.File?.Name;
        _statusMessage = null;
        if (!string.IsNullOrWhiteSpace(_fileName))
        {
            await JS.InvokeAsync<bool>("cookies.set", "bw_last_pdf_name", _fileName, 365);
        }
    }

    private enum DirectoryTarget { Images, Html }
    private DirectoryTarget _directoryTarget = DirectoryTarget.Images;

    private void OpenDirectoryPicker(DirectoryTarget target)
    {
        _directoryTarget = target;
        var initialPath = string.IsNullOrWhiteSpace(TrimmedOutputDirectory)
            ? GetDefaultDirectory()
            : TrimmedOutputDirectory;

        _directoryBrowserError = null;

        if (!TryLoadDirectory(initialPath))
        {
            TryLoadDirectory(GetDefaultDirectory());
        }

        _isDirectoryPickerOpen = true;
    }

    private void CloseDirectoryPicker()
    {
        _isDirectoryPickerOpen = false;
    }

    private void ConfirmDirectorySelection()
    {
        if (!string.IsNullOrWhiteSpace(_directoryBrowserPath))
        {
            if (_directoryTarget == DirectoryTarget.Images)
            {
                _outputDirectory = _directoryBrowserPath;
                JS.InvokeAsync<bool>("cookies.set", "bw_last_output_dir", _outputDirectory, 365);
                RecalculatePagesFromImagesFolder();
            }
            else
            {
                _translationOutputDirectory = _directoryBrowserPath;
                JS.InvokeAsync<bool>("cookies.set", "bw_last_html_dir", _translationOutputDirectory, 365);
            }
        }

        _isDirectoryPickerOpen = false;
    }

    private void NavigateToDirectory(string path)
    {
        TryLoadDirectory(path);
    }

    private void NavigateUp()
    {
        var parent = TryGetParentDirectory(_directoryBrowserPath);
        if (parent is not null)
        {
            TryLoadDirectory(parent.FullName);
        }
    }

    private void RefreshCurrentDirectory()
    {
        TryLoadDirectory(_directoryBrowserPath);
    }

    private async Task StartDecompositionAsync()
    {
        if (_selectedFile is null)
        {
            _statusMessage = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª.";
            _isSuccess = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(TrimmedOutputDirectory))
        {
            _statusMessage = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.";
            _isSuccess = false;
            return;
        }

        _isProcessing = true;
        _statusMessage = null;
        _isSuccess = false;
        _progressPercent = 0;
        _totalPages = 0;

        var progress = new Progress<double>(value =>
        {
            _progressPercent = (int)Math.Clamp(Math.Round(value * 100, MidpointRounding.AwayFromZero), 0, 100);
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await using var stream = _selectedFile.OpenReadStream(MaxFileSize);
            var outputDirectory = TrimmedOutputDirectory;
            var result = await PdfDecomposer.DecomposeAsync(stream, outputDirectory, progress);

            _isSuccess = true;
            _statusMessage = result.PageCount == 0
                ? "–í PDF –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü."
                : $"–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {result.PageCount} –≤ '{outputDirectory}'.";
            _progressPercent = 100;

            _totalPages = result.PageCount;
            _pageFrom = _totalPages > 0 ? 1 : 0;
            _pageTo = _totalPages;
            ValidatePageRange();
        }
        catch (Exception ex)
        {
            _isSuccess = false;
            _statusMessage = $"–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å PDF: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnPageFromChanged(ChangeEventArgs e)
    {
        if (int.TryParse(Convert.ToString(e.Value), out var v))
        {
            _pageFrom = v;
            ValidatePageRange();
        }
    }

    private void OnPageToChanged(ChangeEventArgs e)
    {
        if (int.TryParse(Convert.ToString(e.Value), out var v))
        {
            _pageTo = v;
            ValidatePageRange();
        }
    }

    private void ValidatePageRange()
    {
        _isPageRangeValid = _totalPages > 0 && _pageFrom >= 1 && _pageTo >= 1 && _pageFrom <= _pageTo && _pageTo <= _totalPages;
        _pageRangeError = _isPageRangeValid ? null : "–ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü.";
    }

    private void RecalculatePagesFromImagesFolder()
    {
        try
        {
            if (!string.IsNullOrWhiteSpace(_outputDirectory) && Directory.Exists(_outputDirectory))
            {
                var files = Directory.GetFiles(_outputDirectory, "page-*.png");
                _totalPages = files.Length;
                _pageFrom = _totalPages > 0 ? Math.Clamp(_pageFrom <= 0 ? 1 : _pageFrom, 1, _totalPages) : 0;
                _pageTo = _totalPages > 0 ? Math.Clamp(_pageTo <= 0 ? _totalPages : _pageTo, 1, _totalPages) : 0;
                ValidatePageRange();
            }
            else
            {
                _totalPages = 0;
                ValidatePageRange();
            }
        }
        catch
        {
            _totalPages = 0;
            ValidatePageRange();
        }

        InvokeAsync(StateHasChanged);
    }

    private async Task StartTranslationAsync()
    {
        if (!_isPageRangeValid || string.IsNullOrWhiteSpace(_translationOutputDirectory))
        {
            return;
        }

        _isTranslating = true;
        _translateProgress = 0;
        _translateStatus = null;
        _translateSuccess = false;

        var progress = new Progress<double>(value =>
        {
            _translateProgress = (int)Math.Clamp(Math.Round(value * 100, MidpointRounding.AwayFromZero), 0, 100);
            InvokeAsync(StateHasChanged);
        });

        try
        {
            var count = await Translator.TranslateRangeAsync(_outputDirectory, _pageFrom, _pageTo, _translationOutputDirectory, progress);
            _translateSuccess = count > 0;
            _translateStatus = count == 0
                ? "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞."
                : $"–ì–æ—Ç–æ–≤–æ. –°–æ–∑–¥–∞–Ω–æ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü: {count}. –ü–∞–ø–∫–∞: '{_translationOutputDirectory}'.";
        }
        catch (Exception ex)
        {
            _translateSuccess = false;
            _translateStatus = $"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {ex.Message}";
        }
        finally
        {
            _isTranslating = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private bool TryLoadDirectory(string directory)
    {
        try
        {
            var fullPath = Path.GetFullPath(directory);
            if (!Directory.Exists(fullPath))
            {
                _directoryBrowserError = $"Directory '{directory}' was not found.";
                _directoryEntries = new List<DirectoryEntry>();
                return false;
            }

            _directoryBrowserPath = fullPath;
            _directoryEntries = Directory.GetDirectories(fullPath)
                .OrderBy(dir => dir, StringComparer.OrdinalIgnoreCase)
                .Select(dir => new DirectoryEntry(GetDirectoryDisplayName(dir), dir))
                .ToList();
            _directoryBrowserError = null;
            return true;
        }
        catch (Exception ex)
        {
            _directoryBrowserError = $"Unable to open directory: {ex.Message}";
            _directoryEntries = new List<DirectoryEntry>();
            return false;
        }
    }

    private static string GetDirectoryDisplayName(string path)
    {
        var name = Path.GetFileName(path);
        if (string.IsNullOrEmpty(name))
        {
            name = new DirectoryInfo(path).Name;
        }

        return string.IsNullOrEmpty(name) ? path : name;
    }

    private static DirectoryInfo? TryGetParentDirectory(string? path)
    {
        if (string.IsNullOrWhiteSpace(path))
        {
            return null;
        }

        try
        {
            return Directory.GetParent(path);
        }
        catch
        {
            return null;
        }
    }

    private static string GetDefaultDirectory()
    {
        var candidates = new[]
        {
            Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments),
            Environment.GetFolderPath(Environment.SpecialFolder.Desktop),
            Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
            Environment.CurrentDirectory
        };

        foreach (var candidate in candidates)
        {
            if (!string.IsNullOrWhiteSpace(candidate) && Directory.Exists(candidate))
            {
                return candidate;
            }
        }

        return Environment.CurrentDirectory;
    }

    private sealed record DirectoryEntry(string Name, string FullPath);
}
